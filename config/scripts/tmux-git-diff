#!/usr/bin/env bash
# Git diff browser - interactive diff view with multiple modes

pane_path=$(tmux display-message -p '#{pane_current_path}')
cd "$pane_path" 2>/dev/null || exit 1

git_root=$(git rev-parse --show-toplevel 2>/dev/null)
if [[ -z "$git_root" ]]; then
  echo "Not a git repository"
  sleep 2
  exit 0
fi

cd "$git_root"

# Sprawdź czy są jakieś zmiany
has_changes=$(git status --porcelain 2>/dev/null)
has_staged=$(git diff --cached --name-only 2>/dev/null)

# Menu wyboru trybu
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

clear
printf "${BOLD}${MAGENTA}  Git Diff Browser${NC}\n"
printf "${DIM}──────────────────────────────────────────${NC}\n\n"
printf "  ${BOLD}${CYAN}1${NC}  ${GREEN}Lazygit${NC}            Pełny TUI (stage, commit, diff)\n"
printf "  ${BOLD}${CYAN}2${NC}  ${GREEN}Changed files${NC}      Przeglądaj zmiany plik po pliku\n"
printf "  ${BOLD}${CYAN}3${NC}  ${GREEN}Branch diff${NC}        Diff vs main/master\n"
printf "  ${BOLD}${CYAN}4${NC}  ${GREEN}Last commit${NC}        Co było w ostatnim commicie\n"
printf "\n${DIM}  Press q to close${NC}\n"

read -rsn1 choice

case "$choice" in
  1)
    lazygit
    ;;
  2)
    # FZF + delta: przeglądanie zmienionych plików
    if [[ -z "$has_changes" ]]; then
      echo "No changes to show"
      sleep 2
      exit 0
    fi
    git diff --name-only --diff-filter=ACMR 2>/dev/null | \
      fzf --preview "git diff --color=always -- {} | delta --width=\$FZF_PREVIEW_COLUMNS" \
          --preview-window=right:70%:wrap \
          --bind 'enter:execute(git diff --color=always -- {} | delta | less -R)' \
          --header "Enter: full diff | Ctrl+C: exit"
    ;;
  3)
    # Diff vs main/master
    base_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
    [[ -z "$base_branch" ]] && base_branch="main"

    merge_base=$(git merge-base "$base_branch" HEAD 2>/dev/null)
    if [[ -z "$merge_base" ]]; then
      echo "Cannot find merge base with $base_branch"
      sleep 2
      exit 0
    fi

    git diff "$merge_base"...HEAD --name-only | \
      fzf --preview "git diff ${merge_base}...HEAD --color=always -- {} | delta --width=\$FZF_PREVIEW_COLUMNS" \
          --preview-window=right:70%:wrap \
          --bind "enter:execute(git diff ${merge_base}...HEAD --color=always -- {} | delta | less -R)" \
          --header "Branch diff vs $base_branch | Enter: full diff"
    ;;
  4)
    # Last commit diff
    git diff HEAD~1..HEAD --name-only | \
      fzf --preview "git diff HEAD~1..HEAD --color=always -- {} | delta --width=\$FZF_PREVIEW_COLUMNS" \
          --preview-window=right:70%:wrap \
          --bind 'enter:execute(git diff HEAD~1..HEAD --color=always -- {} | delta | less -R)' \
          --header "Last commit | Enter: full diff"
    ;;
  q|*)
    exit 0
    ;;
esac
