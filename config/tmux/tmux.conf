# =============================================================================
# Tmux Configuration - Catppuccin Mocha Theme
# =============================================================================

# --- Podstawowe ustawienia ---
set -g default-terminal "tmux-256color"
set -s terminal-overrides "linux*:AX@,xterm-256color:RGB"
set -g mouse on
set -g history-limit 10000
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -s escape-time 0
set -g allow-passthrough on
set -g extended-keys on
set -g update-environment "DISPLAY KRB5CCNAME MSYSTEM SSH_ASKPASS SSH_AUTH_SOCK SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY TERM TERM_PROGRAM"

# --- Prefix key (Ctrl+Space) ---
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# --- Vim-like keybindings ---
setw -g mode-keys vi

# Kopiowanie jak w Vim
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"

# Kopiowanie myszką - po zaznaczeniu pokazuje menu z opcjami
bind -T copy-mode-vi MouseDragEnd1Pane {
  display-menu -xM -yM -T "#[align=centre]Selection" \
    "Copy"                    c { send-keys -X copy-pipe-and-cancel "pbcopy" } \
    "Copy & Stay"             C { send-keys -X copy-pipe "pbcopy" } \
    "Search in Google"        g { send-keys -X copy-pipe-and-cancel "pbcopy"; run-shell "open \"https://www.google.com/search?q=$(pbpaste | sed 's/ /+/g')\"" } \
    "" \
    "Select Word"             w { send-keys -X select-word } \
    "Select Line"             l { send-keys -X select-line } \
    "Select All"              a { send-keys -X top-line; send-keys -X begin-selection; send-keys -X bottom-line } \
    "" \
    "Cancel"                  q { send-keys -X cancel }
}

# Podwójne kliknięcie = zaznacz słowo (bez auto-kopiowania)
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word

# Potrójne kliknięcie = zaznacz linię (bez auto-kopiowania)
bind -T copy-mode-vi TripleClick1Pane select-pane \; send-keys -X select-line

# =============================================================================
# Menu kontekstowe - prawy przycisk myszy
# =============================================================================

# Prawy klik na panelu - menu zarządzania
bind -n MouseDown3Pane {
  if -Ft= "#{||:#{mouse_any_flag},#{&&:#{pane_in_mode},#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}}}" {
    select-pane -t=
    send -M
  } {
    display-menu -t= -xM -yM -T "#[align=centre]#{pane_index} (#{pane_id})" \
      "Horizontal Split"      h { split-window -h -c "#{pane_current_path}" } \
      "Vertical Split"        v { split-window -v -c "#{pane_current_path}" } \
      "" \
      "Swap Up"               u { swap-pane -U } \
      "Swap Down"             d { swap-pane -D } \
      "#{?pane_marked,Unmark,Mark}" m { select-pane -m } \
      "#{?pane_marked_set,Swap Marked,-Swap Marked}" s { swap-pane } \
      "" \
      "#{?window_zoomed_flag,Unzoom,Zoom}" z { resize-pane -Z } \
      "Rotate Layout"         r { next-layout } \
      "" \
      "Copy Mode"             c { copy-mode } \
      "Clear History"         C { clear-history } \
      "" \
      "Rename Window"         R { command-prompt -I "#W" "rename-window -- '%%'" } \
      "New Window"            n { new-window -c "#{pane_current_path}" } \
      "" \
      "Respawn Pane"          X { respawn-pane -k } \
      "Kill Pane"             x { kill-pane }
  }
}

# Prawy klik na pasku statusu - menu okien
bind -n MouseDown3Status {
  display-menu -xM -yM -T "#[align=centre]Window #{window_index}" \
    "New Window"              n { new-window -c "#{pane_current_path}" } \
    "Rename Window"           r { command-prompt -I "#W" "rename-window -- '%%'" } \
    "" \
    "Move Left"               l { swap-window -t -1 } \
    "Move Right"              R { swap-window -t +1 } \
    "" \
    "Kill Window"             x { kill-window }
}

# Prawy klik na nazwie sesji - menu sesji
bind -n MouseDown3StatusLeft {
  display-menu -xM -yM -T "#[align=centre]Session" \
    "New Session"             n { new-session } \
    "Rename Session"          r { command-prompt -I "#S" "rename-session -- '%%'" } \
    "" \
    "Choose Session"          s { choose-tree -s } \
    "Choose Window"           w { choose-tree -w } \
    "" \
    "Detach"                  d { detach-client } \
    "Kill Session"            x { kill-session }
}

# Nawigacja między panelami (vim-style z prefix)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# --- Szybka nawigacja BEZ prefix (Option/Alt + key) ---
# Option + strzałki - zmiana paneli
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Cmd + strzałki - zmiana paneli (via Kitty send_text → Alt+Arrow)
# Kitty wysyła te same sekwencje co Alt+Arrow, więc powyższe bindy obsługują oba

# Cmd+Shift + strzałki - zmiana okien (via Kitty → Shift+Alt+Arrow)
bind -n M-S-Left previous-window
bind -n M-S-Right next-window

# Cmd+Shift+N - popup edycji notes (via Kitty custom sequence)
set -s user-keys[0] "\eOn"
bind -n User0 display-popup -w 40% -h 80% -E 'nvim "$(~/.local/bin/tmux-notes)"'

# Cmd+Shift+M - toggle panelu podglądu notes (prawy panel)
set -s user-keys[1] "\eOm"
bind -n User1 run-shell '~/.local/bin/tmux-notes-toggle'

# Cmd+Shift+S - scratchpad (via Kitty → \eOs)
set -s user-keys[2] "\eOs"
bind -n User2 display-popup -w 50% -h 80% -E 'nvim "$(~/.local/bin/tmux-scratch)"'

# Cmd+Shift+H - cheat sheet read-only (via Kitty → \eOh)
set -s user-keys[3] "\eOh"
bind -n User3 display-popup -w 60% -h 85% -E 'nvim -R "$(~/.local/bin/tmux-cheatsheet)"'

# Cmd+Shift+G - git quick view (via Kitty → \eOg)
set -s user-keys[4] "\eOg"
bind -n User4 display-popup -w 65% -h 85% -E '~/.local/bin/tmux-git-quick'

# Cmd+Shift+J - daily journal (via Kitty → \eOj)
set -s user-keys[5] "\eOj"
bind -n User5 display-popup -w 50% -h 80% -E 'nvim "$(~/.local/bin/tmux-journal)"'

# Cmd+Shift+Y - yazi file browser (via Kitty → \eOy)
set -s user-keys[6] "\eOy"
bind -n User6 display-popup -w 80% -h 85% -E 'yazi'

# Cmd+Shift+? - shortcuts help (via Kitty → \eO?)
set -s user-keys[7] "\eO?"
bind -n User7 display-popup -w 95% -h 90% -E '~/.local/bin/tmux-shortcuts-help'

# Cmd+Shift+D - git diff view / lazygit (via Kitty → \eOd)
set -s user-keys[8] "\eOd"
bind -n User8 run-shell 'tmux display-popup -w 90% -h 90% -d "#{pane_current_path}" -E "cd \"#{pane_current_path}\" && lazygit"'

# Cmd+Shift+K - lazydocker (via Kitty → \eOk)
set -s user-keys[9] "\eOk"
bind -n User9 display-popup -w 90% -h 90% -E 'lazydocker'

# Cmd+Shift+B - lazysql / Baza danych (via Kitty → \eOb)
set -s user-keys[10] "\eOb"
bind -n User10 display-popup -w 90% -h 90% -E 'lazysql'

# Cmd+Shift+T - btop system monitor (via Kitty → \eOt)
set -s user-keys[11] "\eOt"
bind -n User11 display-popup -w 85% -h 85% -E 'btop'

# Cmd+Shift+P → command palette (Kitty wysyła Ctrl+Q, tmux przepuszcza do nvim)
# (user-keys[12] zwolniony — Ctrl+Q nie wymaga tmux binding)

# Cmd+Shift+I - pet snippets (via Kitty → \eOi)
set -s user-keys[12] "\eOi"
bind -n User12 display-popup -w 70% -h 80% -E '~/.local/bin/tmux-pet-clip'

# Cmd+Shift+E - aerc email client (via Kitty → \eOe)
set -s user-keys[13] "\eOe"
bind -n User13 display-popup -w 90% -h 90% -E 'aerc'

# Cmd+Shift+A - Claude account switcher (via Kitty → \eOa)
set -s user-keys[14] "\eOa"
bind -n User14 display-popup -w 60% -h 50% -E '~/.local/bin/tmux-claude-account'

# Option + 1-9 - bezpośrednia zmiana okien
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Option + n/p - następne/poprzednie okno
bind -n M-n next-window
bind -n M-p previous-window

# Resize paneli (vim-style)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# --- Split windows (intuicyjne) ---
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# --- Reload config ---
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# --- Status bar position ---
set -g status-position bottom

# =============================================================================
# Catppuccin Mocha Theme (manual - matching Neovim/Yazi)
# =============================================================================

# Colors
set -g @catppuccin_flavour 'mocha'

# Mocha palette
thm_bg="#1e1e2e"
thm_fg="#cdd6f4"
thm_cyan="#89dceb"
thm_black="#181825"
thm_gray="#313244"
thm_magenta="#cba6f7"
thm_pink="#f5c2e7"
thm_red="#f38ba8"
thm_green="#a6e3a1"
thm_yellow="#f9e2af"
thm_blue="#89b4fa"
thm_orange="#fab387"
thm_black4="#585b70"

# Status bar
set -g status-style "bg=${thm_bg},fg=${thm_fg}"
set -g status-left-length 100
set -g status-right-length 100

# Status left (session name)
set -g status-left "#[fg=${thm_bg},bg=${thm_blue},bold]  #S #[fg=${thm_blue},bg=${thm_bg}]"

# Status right (tasks, time, date)
set -g status-right "#[fg=${thm_yellow}]#(~/.local/bin/tmux-notes-count) #[fg=${thm_gray}]#[fg=${thm_fg},bg=${thm_gray}] %H:%M #[fg=${thm_blue}]#[fg=${thm_bg},bg=${thm_blue},bold] %d-%m "
set -g status-interval 5  # Odświeżaj co 5s (dla licznika tasków)

# Window status
set -g window-status-format "#[fg=${thm_bg},bg=${thm_gray}]#[fg=${thm_fg},bg=${thm_gray}] #I #W #[fg=${thm_gray},bg=${thm_bg}]"
set -g window-status-current-format "#[fg=${thm_bg},bg=${thm_magenta}]#[fg=${thm_bg},bg=${thm_magenta},bold] #I #W #[fg=${thm_magenta},bg=${thm_bg}]"

# Pane borders
set -g pane-border-style "fg=${thm_gray}"
set -g pane-active-border-style "fg=${thm_blue}"

# Pane background - aktywny panel jasny, nieaktywne przyciemnione
set -g window-active-style "bg=${thm_bg}"      # aktywny: #1e1e2e (domyślne)
set -g window-style "bg=#1a1a1a"               # nieaktywne: ciemniejsze

# Message style
set -g message-style "fg=${thm_cyan},bg=${thm_gray}"

# =============================================================================
# Plugins (TPM)
# =============================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_selection_mouse 'clipboard'  # mysz kopiuje do systemowego schowka
set -g @plugin 'jaclu/tmux-menus'         # rozbudowane menu (prefix + \)
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Resurrect - zapisywanie i przywracanie sesji
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Continuum - automatyczne zapisywanie
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Undercurl support (dla LSP errors w nvim)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Initialize TPM (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'
